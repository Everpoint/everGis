<!DOCTYPE html>
<html>
    <head>
        <title>sGis Framework - Distance and Area Measuring Sample</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width">
        
        <style>
            body, html {margin: 0px; overflow: hidden; height: 100%;}
            div#map {width: 100%; height: 100%;}
            div.control_pane {position: absolute; top: 15px; right: 15px; width: 300px; background-color: rgba(255, 255, 255, 0.7);}
            
            .coordinateLabel {
                background-color: rgba(200, 200, 200, 0.5);
                border: 1px solid black;
                border-radius: 5px;
                font-size: 10px;
            }
            
            .distanceLabel {
                background-color: rgba(100, 100, 200, 0.5);
                border: 1px solid black;
                border-radius: 5px;
            }
           
        </style>

        <script src="..\Source\sGis\sGis.js"></script>
        <script src="..\Source\sGis\Geotools.js"></script>
        <script src="..\Source\sGis\RBush.js"></script>
        <script src="..\Source\sGis\Event.js"></script>
        <script src="..\Source\sGis\utils.js"></script>
        <script src="..\Source\sGis\utils\utils.js"></script>
        <script src="..\Source\sGis\utils\proto.js"></script>
        <script src="..\Source\sGis\Crs.js"></script>
        <script src="..\Source\sGis\IEventHandler.js"></script>
        <script src="..\Source\sGis\geom.js"></script>
        <script src="..\Source\sGis\Painter.js"></script>
        <script src="..\Source\sGis\Layer.js"></script>
        <script src="..\Source\sGis\LayerGroup.js"></script>
        <script src="..\Source\sGis\Map.js"></script>
        <script src="..\Source\sGis\TileLayer.js"></script>
        <script src="..\Source\sGis\DynamicLayer.js"></script>
        <script src="..\Source\sGis\FeatureLayer.js"></script>
        <script src="..\Source\sGis\ESRIDynamicLayer.js"></script>
        <script src="..\Source\sGis\Decorations.js"></script>
        <script src="..\Source\sGis\geom\Arc.js"></script>
        <script src="..\Source\sGis\geom\Point.js"></script>
        <script src="..\Source\sGis\geom\Polyline.js"></script>
        <script src="..\Source\sGis\geom\Polygon.js"></script>
        <script src="..\Source\sGis\symbols\Symbol.js"></script>
        <script src="..\Source\sGis\symbols\Maptip.js"></script>
        <script src="..\Source\sGis\symbols\Point.js"></script>
        <script src="..\Source\sGis\symbols\Polyline.js"></script>
        <script src="..\Source\sGis\symbols\Polygon.js"></script>
        <script src="..\Source\sGis\features\Feature.js"></script>
        <script src="..\Source\sGis\features\Image.js"></script>
        <script src="..\Source\sGis\features\FeatureGroup.js"></script>
        <script src="..\Source\sGis\features\Point.js"></script>
        <script src="..\Source\sGis\features\Polyline.js"></script>
        <script src="..\Source\sGis\features\Polygon.js"></script>
        <script src="..\Source\sGis\features\Label.js"></script>
        <script src="..\Source\sGis\features\Maptip.js"></script>
        <script src="..\Source\sGis\features\PointGroup.js"></script>
        <script src="..\Source\sGis\controls\Control.js"></script>
        <script src="..\Source\sGis\controls\Point.js"></script>
        <script src="..\Source\sGis\controls\Polyline.js"></script>
        <script src="..\Source\sGis\controls\Polygon.js"></script>
        <script src="..\Source\sGis\controls\Editor.js"></script>
        <script src="..\Source\sGis\controls\Distance.js"></script>
        <script src="..\Source\sGis\controls\Area.js"></script>
        <script src="..\Source\sGis\controls\Rectangle.js"></script>
        <script src="..\Source\sGis\controls\BaseLayerSwitch.js"></script>

        <script src="..\Source\spatialProcessor\Connector.js"></script>
        <script src="..\Source\spatialProcessor\MapServer.js"></script>
        <script src="..\Source\spatialProcessor\DataTree.js"></script>
        <script src="..\Source\spatialProcessor\xmlSerializer.js"></script>
        <script src="..\Source\spatialProcessor\Sfs.js"></script>
        <script src="..\Source\spatialProcessor\Template.js"></script>
        <script src="..\Source\spatialProcessor\Printer.js"></script>
        <script src="..\Source\spatialProcessor\controller\Controller.js"></script>
        <script src="..\Source\spatialProcessor\controller\Identify.js"></script>
        <script src="..\Source\spatialProcessor\controller\SuperSearch.js"></script>
        <script src="..\Source\spatialProcessor\controller\DitIntegration.js"></script>
        <script src="..\Source\spatialProcessor\controller\ClientLayer.js"></script>
        <script src="..\Source\spatialProcessor\controller\DefinitionQuery.js"></script>
        <script src="..\Source\spatialProcessor\controller\TableView.js"></script>
        <script src="..\Source\spatialProcessor\DataAccessService.js"></script>

        <script src="..\Source\spatialProcessor\mapItem\MapItem.js"></script>
        <script src="..\Source\spatialProcessor\mapItem\Folder.js"></script>
        <script src="..\Source\spatialProcessor\mapItem\MapServer.js"></script>
        <script src="..\Source\spatialProcessor\mapItem\ClientLayer.js"></script>
        <script src="..\Source\spatialProcessor\mapItem\DynamicServiceLayer.js"></script>

        <script src="..\Source\spatialProcessor\SpatialProcessor.js"></script>

        <script src="..\Source\spatialProcessor\Application.js"></script>
    </head>
    <body>
        <!--
            Пример измерения расстояний и площадей
        -->
        <div id="map"></div>
        <div class="control_pane">
            <input type="radio" name="control" id="length" onchange="toggleControl()" checked/><label for="distance">Измерять расстояния</label><br>
            <input type="radio" name="control" id="area" onchange="toggleControl()" /><label for="area">Измерять площадь</label>
        </div>
        <script>
            window.onload = function() {
            
            var sp = new sGis.SpatialProcessor({
                    url: 'http://dev2.everpoint.ru/evergis/SpatialProcessor/IIS/', login: 'z', password: 'z',
                    mapWrapper: 'map',
                    services: ['osm']
                }),            
                featureLayer = new sGis.FeatureLayer(),
                lineControl = new sGis.controls.Polyline(sp.map, {style: {strokeColor: 'red', strokeWidth: 3}}),
                polygonControl = new sGis.controls.Polygon(sp.map, {style: {strokeColor: 'red', strokeWidth: 3, fillColor: 'rgba(100, 100, 100, 0.3'}});
                
                sp.map.addLayer(featureLayer);
                lineControl.activeLayer = featureLayer;
                lineControl.activate();
                
                lineControl.addListener('drawingBegin', function() {
                    var feature = featureLayer.features[featureLayer.features.length - 1],
                        coord = feature.coordinates[0],
                        label = new sGis.feature.Label(coord[1], {content: '', style: {offset: {x: 2, y: -22}, css: 'distanceLabel', width: 100}, crs: sp.map.crs});
                        
                    featureLayer.add(label);
                        
                    sp.map.addListener('mousemove.printingCoord', function() {
                        label.coordinates = feature.coordinates[0][feature.coordinates[0].length - 1];
                        label.content = '' + sGis.geotools.length(feature).toFixed(2) + 'м';
                    });
                });
                
                lineControl.addListener('pointAdd', showCoordinates);
                
                polygonControl.activeLayer = featureLayer;
                
                polygonControl.addListener('drawingBegin', function() {
                    var feature = featureLayer.features[featureLayer.features.length - 1],
                        label = new sGis.feature.Label(feature.centroid, {content: '', crs: feature.crs, style: {css: 'distanceLabel', offset: {x: -50, y: -10}, width: 100}});
                        
                    featureLayer.add(label);
                    
                    sp.map.addListener('mousemove.printingCoord', function() {
                        label.coordinates = feature.centroid;
                        label.content = '' + (sGis.geotools.area(feature) / 10000).toFixed(2) + 'га';
                    });
                });
                
                polygonControl.addListener('pointAdd', showCoordinates);
                
                function showCoordinates(sGisEvent) {
                    var coord = this.activeFeature.coordinates,
                        ring = coord[coord.length - 1],
                        labelCoordinates = ring[ring.length - 2],
                        projected = new sGis.Point(labelCoordinates[0], labelCoordinates[1], sp.map.crs).projectTo(sGis.CRS.geo),
                        label = new sGis.feature.Label(projected, {content: projected.y.toFixed(2) + ', ' + projected.x.toFixed(2), style: {css: 'coordinateLabel', height: 12, width: 70, offset: {x: 2, y: 2}}});
                
                    featureLayer.add(label);
                    sp.map.redrawLayer(featureLayer);
                }
                
                var lengthRadio = document.getElementById('length'),
                    areaRadio = document.getElementById('area');
            
                lengthRadio.onchange = toggleControl;
                areaRadio.onchange = toggleControl;
                
                function toggleControl() {
                    if (lengthRadio.checked) {
                        lineControl.activate();
                        polygonControl.deactivate();
                    } else {
                        lineControl.deactivate();
                        polygonControl.activate();
                    }
                }
            }
        </script>
    </body>
</html>
