<!DOCTYPE html>
<html>
    <head>
        <title>sGis Framework - Distance and Area Measuring Sample</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width">
        
        <style>
            body, html {margin: 0px; overflow: hidden; height: 100%;}
            div#map {width: 100%; height: 100%;}
            div.control_pane {position: absolute; top: 15px; right: 15px; width: 300px; background-color: rgba(255, 255, 255, 0.7);}
            
            .coordinateLabel {
                background-color: rgba(200, 200, 200, 0.5);
                border: 1px solid black;
                border-radius: 5px;
                font-size: 10px;
            }
            
            .distanceLabel {
                background-color: rgba(100, 100, 200, 0.5);
                border: 1px solid black;
                border-radius: 5px;
            }
           
        </style>

        <script src="http://dev2.everpoint.ru/EverGIS/HTML5/005/evergis.js"></script>
    </head>
    <body>
        <!--
            Пример измерения расстояний и площадей
        -->
        <div id="map"></div>
        <div class="control_pane">
            <input type="radio" name="control" id="length" onchange="toggleControl()" checked/><label for="distance">Измерять расстояния</label><br>
            <input type="radio" name="control" id="area" onchange="toggleControl()" /><label for="area">Измерять площадь</label>
        </div>
        <script>
            window.onload = function() {
            
            var sp = new sGis.SpatialProcessor({
                    url: 'http://dev2.everpoint.ru/eg_public/SpatialProcessor/IIS/', login: 'jspublic', password: 'jspublic',
                    mapWrapper: 'map',
                    services: ['osm']
                }),            
                featureLayer = new sGis.FeatureLayer(),
                lineControl = new sGis.controls.Polyline(sp.map, {style: {strokeColor: 'red', strokeWidth: 3}}),
                polygonControl = new sGis.controls.Polygon(sp.map, {style: {strokeColor: 'red', strokeWidth: 3, fillColor: 'rgba(100, 100, 100, 0.3'}});
                
                sp.map.addLayer(featureLayer);
                lineControl.activeLayer = featureLayer;
                lineControl.activate();
                
                lineControl.addListner('drawingBegin', function() {
                    var feature = featureLayer.features[featureLayer.features.length - 1],
                        coord = feature.coordinates[0],
                        label = new sGis.feature.Label(coord[1], {content: '', style: {offset: {x: 2, y: -22}, css: 'distanceLabel', width: 100}, crs: sp.map.crs});
                        
                    featureLayer.add(label);
                        
                    sp.map.addListner('mousemove.printingCoord', function() {
                        label.coordinates = feature.coordinates[0][feature.coordinates[0].length - 1];
                        label.content = '' + sGis.geotools.length(feature).toFixed(2) + 'м';
                    });
                });
                
                lineControl.addListner('pointAdd', showCoordinates);
                
                polygonControl.activeLayer = featureLayer;
                
                polygonControl.addListner('drawingBegin', function() {
                    var feature = featureLayer.features[featureLayer.features.length - 1],
                        label = new sGis.feature.Label(feature.centroid, {content: '', crs: feature.crs, style: {css: 'distanceLabel', offset: {x: -50, y: -10}, width: 100}});
                        
                    featureLayer.add(label);
                    
                    sp.map.addListner('mousemove.printingCoord', function() {
                        label.coordinates = feature.centroid;
                        label.content = '' + (sGis.geotools.area(feature) / 10000).toFixed(2) + 'га';
                    });
                });
                
                polygonControl.addListner('pointAdd', showCoordinates);
                
                function showCoordinates(sGisEvent) {
                    var coord = this.activeFeature.coordinates,
                        ring = coord[coord.length - 1],
                        labelCoordinates = ring[ring.length - 2],
                        projected = new sGis.Point(labelCoordinates[0], labelCoordinates[1], sp.map.crs).projectTo(sGis.CRS.geo),
                        label = new sGis.feature.Label(projected, {content: projected.y.toFixed(2) + ', ' + projected.x.toFixed(2), style: {css: 'coordinateLabel', height: 12, width: 70, offset: {x: 2, y: 2}}});
                
                    featureLayer.add(label);
                    sp.map.redrawLayer(featureLayer);
                }
                
                var lengthRadio = document.getElementById('length'),
                    areaRadio = document.getElementById('area');
            
                lengthRadio.onchange = toggleControl;
                areaRadio.onchange = toggleControl;
                
                function toggleControl() {
                    if (lengthRadio.checked) {
                        lineControl.activate();
                        polygonControl.deactivate();
                    } else {
                        lineControl.deactivate();
                        polygonControl.activate();
                    }
                }
            }
        </script>
    </body>
</html>
