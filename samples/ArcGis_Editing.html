<!DOCTYPE html>
<html>
<head>
    <title>sGis Framework - ArcGis Layer Editing Sample</title>
    <meta charset="UTF-8">
    <style>
        body, html {margin: 0px; overflow: hidden; height: 100%;}
        div#map {width: 100%; height: 100%;}
        button {width: 194px; margin: 3px}

        .editingChoice {width: 200px;position: absolute;right: 15px; top: 15px;background-color: #eee;}
    </style>

    <script src="http://dev2.everpoint.ru/EverGIS/HTML5/005/evergis.js"></script>

</head>
<body>
    <!--
    Пример редактирования слоя ArcGis.
    -->
    <div id="map"></div>
    <div class="editingChoice">
        <button id="addPoint">Добавить точку</button><br/>
        <button id="addPolyline">Добавить линию</button><br/>
        <button id="addPolygon">Добавить полигон</button><br/>

        <input type="radio" id="pointLayer" name="layer" checked /><label for="pointLayer">Редактировать точки</label><br />
        <input type="radio" id="polylineLayer" name="layer" /><label for="polylineLayer">Редактировать линии</label><br />
        <input type="radio" id="polygonLayer" name="layer" /><label for="polygonLayer">Редактировать полигоны</label>
    </div>
    <script>
        window.onload = function() {
            
        var sp = new sGis.SpatialProcessor({
            url: 'http://dev2.everpoint.ru/eg_public/SpatialProcessor/IIS/', login: 'jspublic', password: 'jspublic',
            mapWrapper: 'map',
            services: ['osm', 'evergisjs_mrc_fs_test']
        });
        
        sp.service.evergisjs_mrc_fs_test.addListener('initialize', function() {
            var editor = new sGis.controls.Editor(sp.map),
                featureLayer = new sGis.FeatureLayer(),
                lastSelectedId;
            sp.map.addLayer(featureLayer);
            editor.activeLayer = featureLayer;

            var dataAccess = new sGis.spatialProcessor.DataAccessService(sp.connector, 'DataAccess'),
                self = this,
                pointLayerStorage = this.layerInfo[0].LayerInfo.storageId,
                polylineLayerStorage = this.layerInfo[1].LayerInfo.storageId,
                polygonLayerStorage = this.layerInfo[2].LayerInfo.storageId;

            var buffer = sp.map.resolution * 5;
            sp.map.addListener('click', function(sGisEvent) {

                var tempPolygon = new sGis.feature.Polygon([
                    [sGisEvent.point.x - buffer, sGisEvent.point.y - buffer],
                    [sGisEvent.point.x - buffer, sGisEvent.point.y + buffer],
                    [sGisEvent.point.x + buffer, sGisEvent.point.y + buffer],
                    [sGisEvent.point.x + buffer, sGisEvent.point.y - buffer]
                ], {crs: sp.map.crs});

                dataAccess.query({
                    geometry: tempPolygon,
                    layerStorageId: self.layerInfo[getLayerIndex()].LayerInfo.storageId,
                    success: function (features) {
                        if (features.length > 0 && (!editor.selectedFeature || editor.selectedFeature.id !== features[0].id) && lastSelectedId !== features[0].id) {
                            featureLayer.features = features;
                            editor.activate();
                            editor.selectFeature(features[0]);

                            var ids = [];
                            for (var i = 0; i < features.length; i++) {
                                ids.push(features[i].id);
                            }

                            lastSelectedId = features[0].id;
                        }
                    }
                });
            });

            editor.addListener('featureDeselect', function(sGisEvent) {
                dataAccess.save({
                    updated: [sGisEvent.feature],
                    layerStorageId: self.layerInfo[getLayerIndex()].LayerInfo.storageId,
                    success: function() {

                    },
                    error: function() {
                        alert('Error');
                    }
                });
            });

            editor.addListener('featureRemove', function(sGisEvent) {
                dataAccess.save({
                    deleted: [sGisEvent.feature],
                    layerStorageId: self.layerInfo[getLayerIndex()].LayerInfo.storageId
                });
            });
            
            document.getElementById('addPolygon').onclick = function() {
                var feature = new sGis.feature.Polygon([[4100000, 7500000], [4200000, 7500000], [4200000, 7600000], [4100000, 7600000]], { crs: sp.map.crs });
                
                dataAccess.createObject({
                    object: feature,
                    templatePath: 'd:\\startup\\public.assetlib\\fb52ab32-c100-4122-8598-95511f50a8e1.asset',
                    layerStorageId: polygonLayerStorage,
                    error: function() {
                        alert('Ошибка');
                    }
                });
            };

            document.getElementById('addPolyline').onclick = function() {
                var feature = new sGis.feature.Polyline([[4100000, 7500000], [4200000, 7500000], [4200000, 7600000], [4100000, 7600000]], { crs: sp.map.crs });

                dataAccess.createObject({
                    object: feature,
                    templatePath: 'd:\\startup\\public.assetlib\\f9fae063-26f8-4de5-b7ba-66358aba8e1b.asset',
                    layerStorageId: polylineLayerStorage,
                    error: function() {
                        alert('Ошибка');
                    }
                });
            };

            document.getElementById('addPoint').onclick = function() {
                var feature = new sGis.feature.Point([4100000, 7500000], { crs: sp.map.crs });

                dataAccess.createObject({
                    object: feature,
                    templatePath: 'd:\\startup\\public.assetlib\\14d706b9-b701-42fd-8f0c-8f347a7c2a7e.asset',
                    layerStorageId: pointLayerStorage,
                    error: function() {
                        alert('Ошибка');
                    }
                });
            };

            var pointLayerRadio = document.getElementById('pointLayer'),
                polylineLayerRadio = document.getElementById('polylineLayer');

            function getLayerIndex() {
                if (pointLayerRadio.checked) {
                    return 0;
                } else if (polylineLayerRadio.checked) {
                    return 1;
                } else {
                    return 2;
                }
            }
        });

        };
    </script>
</body>
</html>
