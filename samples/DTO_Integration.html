<!DOCTYPE html>
<html>
    <head>
        <title>sGis Framework - DTO integration Sample</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width">
        <style>
            body, html {margin: 0px; overflow: hidden; height: 100%;}
            div#map {width: 100%; height: 100%;}
        </style>

        <script src="http://dev2.everpoint.ru/EverGIS/HTML5/005/evergis.js"></script>


    </head>
    <body>
        <div id="map"></div>
        <input type="button" id="showButton" value="Показать данные" style="position: absolute; right: 15px; top: 15px;"/> 
        <input type="button" id="updateButton" value="Обновить данные ArcGis" style="position: absolute; right: 15px; top: 40px;"/><br> 
        <input type="text" id="layerId" value="cars" placeholder="Layer Id" style="position: absolute; right: 15px; top: 65px;"/><br>
        <input type="text" id="moduleId" value="geo" placeholder="Module Id" style="position: absolute; right: 15px; top: 90px;"/><br>
        <input type="text" id="queryId" value="6" placeholder="Query Id" style="position: absolute; right: 15px; top: 115px;"/><br>
        <div id="message" style="position: absolute; right: 15px; top: 140px;"></div>
        <script>
            window.onload = function() {
                var sp = new sGis.SpatialProcessor({
                        url: 'http://dev2.everpoint.ru/EverGIS/SpatialProcessor/IIS/', login: 'z', password: 'x',
                        mapWrapper: 'map',
                        services: ['egko'],
                        controllers: ['identify', 'ditIntegration']
                    });
                    
                var featureLayer = new sGis.FeatureLayer();
                
                document.getElementById('showButton').onclick = showData;

                function showData() {
                    sp.controller.ditIntegration.disintegrate({
                        layerId: document.getElementById('layerId').value,
                        moduleId: document.getElementById('moduleId').value,
                        queryId: document.getElementById('queryId').value,
                        requested: function() {
                            document.getElementById('message').innerHTML = 'Данные запрошены. Пожалуйста, подождите...';
                        },
                        success: function() {
                            document.getElementById('message').innerHTML = 'Объекты отображены на карте!';
                        }
                    });
                }

                document.getElementById('updateButton').onclick = function() {

                    sp.controller.ditIntegration.loadLayerData({
                        requested: function() {
                            document.getElementById('message').innerHTML = 'Обновление данных на сервере запрошено. Пожалуйста, подождите...';
                        },

                        success: function() {
                            document.getElementById('message').innerHTML = 'Обновление данных завершено!';
                        }                    
                    });
                };
                    
                sp.map.addListner('click', function(sGisEvent) {
                    document.getElementById('message').innerHTML = 'Ожидаем ответ от сервера...';

                    var point = sGisEvent.point,
                        buffer = sp.map.resolution * 10,
                        polygon = new sGis.feature.Polygon([[point.x - buffer, point.y - buffer], [point.x + buffer, point.y - buffer], [point.x + buffer, point.y + buffer], [point.x - buffer, point.y + buffer]]);

                    sp.controller.identify.identify({geometry: polygon, success: function() {
                        var output = 'Объекты не найдены';
                        var rows = sp.controller.identify.tree.rows;

                        for (var i in rows) {
                            if (rows[i].dataType === 'LeafNode') {
                                output = 'Завершено';
                                query(rows[i].data.StorageId);
                                break;
                            }
                        }
                        featureLayer.features = [];
                        if (sp.map.getLayerIndex(featureLayer) !== -1) sp.map.redrawLayer(featureLayer);
                        document.getElementById('message').innerHTML = output;
                    }});                
                });

                function query(storageId) {
                    sp.controller.identify.query({storageId: storageId, success: function(features) {
                        var object = features[0],
                            output = '';
                        for (var j in object.attributes) {
                            output += '<div>' + object.attributes[j].title + ': ' + object.attributes[j].value + '</div>';
                        }
                        
                        var mapTip = new sGis.feature.Maptip(object.centroid || object.coordinates, {content: output, crs: object.crs});
                        featureLayer.features = [mapTip];
                        
                        if (sp.map.getLayerIndex(featureLayer) === -1) {
                            sp.map.addLayer(featureLayer);
                        } else {
                            sp.map.redrawLayer(featureLayer);
                        }
                    }});
                }
            };
        </script>
    </body>
</html>
