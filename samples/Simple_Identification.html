<!DOCTYPE html>
<html>
    <head>
        <title>sGis Framework - Identification Sample</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width">
        <style>
            body, html {margin: 0px; overflow: hidden; height: 100%;}
            div#map {width: 100%; height: 100%;}
        </style>

        <script src="http://dev2.everpoint.ru/EverGIS/HTML5/005/evergis.js"></script>
    </head>
    <body>
        <!--
            Пример идентификации Spatial Processor. Нажмите на объект, чтобы получить информацию.
        -->
        <div id="map"></div>
        <script>
            window.onload = function() {
            
            var sp = new sGis.SpatialProcessor({
                    url: 'http://dev2.everpoint.ru/eg_public/SpatialProcessor/IIS/', login: 'jspublic', password: 'jspublic',
                    mapWrapper: 'map',
                    services: ['osm', 'evergisjs_mrc_test'],
                    controllers: ['identify']
                }),
                featureLayer = new sGis.FeatureLayer();
        
            sp.service.osm.addListner('initialize', function() {
                sp.map.addLayer(featureLayer);
            });
            
            sp.map.addListner('click', function(sGisEvent) {
                featureLayer.features = [];
                sp.map.moveLayerToIndex(featureLayer, 10);
                var point = sGisEvent.point,
                    polygon = new sGis.feature.Polygon([[point.x, point.y], [point.x + 1, point.y], [point.x + 1, point.y + 1], [point.x, point.y+1]]);
                    
                sp.controller.identify.identify({
                    geometry: polygon,
                    success: function() {
                        var rows = sp.controller.identify.tree.rows;

                        for (var i in rows) {
                            if (rows[i].dataType === 'LeafNode') {
                                query(rows[i].data.StorageId);
                                return;
                            }
                        }
                    }
                });                
            });
            
            function query(storageId) {
                sp.controller.identify.query({
                    storageId: storageId,
                    success: function(objects) {
                        var maptip = new sGis.feature.Maptip(objects[0].centroid || objects[0].coordinates, {
                            crs: objects[0].crs,
                            content: getAttributeTable(objects[0]),
                            style: {width: 400}
                        });
                        
                        featureLayer.add(maptip);
                        sp.map.redrawLayer(featureLayer);
                    }
                });
            }
            
            function getAttributeTable(feature) {
                var attributes = feature.attributes,
                    string = '';
                for (var i in attributes) {
                    string += attributes[i].title + ': ' + attributes[i].value + '<br>';
                }
                return string;
            }        
            }
        </script>
    </body>
</html>
