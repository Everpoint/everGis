<!DOCTYPE html>
<html>
<head>
    <title>sGis Framework - Client Layer Editing Sample</title>
    <meta charset="UTF-8">
    <style>
        body, html {margin: 0px; overflow: hidden; height: 100%;}
        div#map {width: 100%; height: 100%;}
    </style>
    <script src="http://dev2.everpoint.ru/EverGIS/HTML5/005/evergis.js"></script>


</head>
<body>
    <!--
    Пример редактирования клиентского слоя.
    -->
    <div id="map"></div>
    <script>
        window.onload = function() {
            
        var sp = new sGis.SpatialProcessor({
            url: 'http://dev2.everpoint.ru/eg_public/SpatialProcessor/IIS/', login: 'jspublic', password: 'jspublic',
            mapWrapper: 'map',
            services: ['osm']
        });
        
        sp.service.osm.addListner('initialize', function() {
            var editor = new sGis.controls.Editor(sp.map),
                featureLayer = new sGis.FeatureLayer(),
                lastSelectedId;
            sp.map.addLayer(featureLayer);
            editor.activeLayer = featureLayer;
            
            var controller = sp.addController('clientLayer', { serviceName: 'eg_layer1' });

            var buffer = sp.map.resolution * 5;
            sp.map.addListner('click', function(sGisEvent) {
                var tempPolygon = new sGis.feature.Polygon([
                    [sGisEvent.point.x - buffer, sGisEvent.point.y - buffer],
                    [sGisEvent.point.x - buffer, sGisEvent.point.y + buffer],
                    [sGisEvent.point.x + buffer, sGisEvent.point.y + buffer],
                    [sGisEvent.point.x + buffer, sGisEvent.point.y - buffer]
                ], {crs: sp.map.crs});

                controller.query({
                    geometry: tempPolygon,
                    success: function (features) {
                        if (features.length > 0 && (!editor.selectedFeature || editor.selectedFeature.id !== features[0].id) && lastSelectedId !== features[0].id) {
                            featureLayer.features = features;
                            sp.map.moveLayerToIndex(featureLayer, 2);
                            sp.map.redrawLayer(featureLayer);

                            editor.activate();
                            editor.selectFeature(features[0]);

                            var ids = [];
                            for (var i = 0; i < features.length; i++) {
                                ids.push(features[i].id);
                            }
                            controller.mapServer.hideObjects(ids);

                            lastSelectedId = features[0].id;
                        }
                    }
                });
            });

            editor.addListner('featureDeselect', function(sGisEvent) {
                controller.save({
                    updated: [sGisEvent.feature],
                    success: function() {
                        
                    },
                    error: function() {
                        alert('Error');
                    }
                });
            });

            editor.addListner('featureRemove', function(sGisEvent) {
                controller.save({
                    deleted: [sGisEvent.feature]
                });
            });
        });

        };
    </script>
</body>
</html>
