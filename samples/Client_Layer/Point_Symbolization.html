<!DOCTYPE html>
<html>
<head>
    <title>sGis Framework - Point Symbolization</title>
    <meta charset="UTF-8">
    <style>
        body, html {
            margin: 0px;
            overflow: hidden;
            height: 100%;
        }

        div#map {
            width: 100%;
            height: 100%;
        }
    </style>
    <script src="http://dev2.everpoint.ru/EverGIS/HTML5/005/evergis.js"></script>

</head>
<body>
    <!--
    Пример символизации точечных объектов по двум параметрам.
    -->
    <div id="map"></div>
    <script>
        window.onload = function() {

            var sp = new sGis.SpatialProcessor({
                url: 'http://dev2.everpoint.ru/eg_public/SpatialProcessor/IIS/', login: 'jspublic', password: 'jspublic',
                mapWrapper: 'map',
                services: ['osm', 'evergisjs_mrc_test']
            });

            sp.service.evergisjs_mrc_test.addListener('initialize', function() {
                sp.service.evergisjs_mrc_test.display = false;

                var clientLayer = sp.addController('clientLayer');
                clientLayer.copy({
                    storageId: sp.service.evergisjs_mrc_test.layerInfo[0].LayerInfo.storageId,
                    success: function() {
                        applySymbolization();
                    }
                });

                function applySymbolization() {

                    clientLayer.getClassifiers({
                        geometryType: 'point',
                        propertyName: 'Fill',
                        success: function(properties) {
                            properties[1].AttributeName = 'LINE';
                            getColorTable(properties[1]);
                        }
                    });

                    clientLayer.getClassifiers({
                        geometryType: 'point',
                        propertyName: 'Size',
                        success: function(properties) {
                            properties[1].AttributeName = 'BPAAMOUNT';
                            properties[1].Settings.MinValue = 5;
                            properties[1].Settings.MaxValue = 36;
                            getSizeTable(properties[1]);
                        }
                    });

                    var tables = [];
                    function getColorTable(settings) {
                        clientLayer.buildClassifierTable({
                            geometryType: 'point',
                            settings: [settings],
                            success: function(table) {
                                for (var i in table) {
                                    table[i].PropertyValue.Color = lineColors[table[i].AttributeValueMax];
                                }
                                tables.push(table);
                                if (tables.length === 2) applySymbolizer();
                            }
                        });
                    }

                    function getSizeTable(settings) {
                        clientLayer.buildClassifierTable({
                            geometryType: 'point',
                            settings: [settings],
                            success: function(table) {
                                tables.push(table);
                                if (tables.length === 2) applySymbolizer();
                            }
                        });
                    }

                    function applySymbolizer() {
                        clientLayer.applySymbolizer({
                            tables: {
                                point: tables
                            }
                        });
                    }
                }
            });

            var lineColors = {
                'Арбатско-Покровская линия': '#FF0000AA',
                'Бутовская линия Лёгкого метро': '#FFAAAAFF',
                'Замоскворецкая линия': '#FF00FF00',
                'Калининская линия': '#FFFFFF00',
                'Калужско-Рижская линия': '#FFFFCC00',
                'Каховская линия': '#FF00CCCC',
                'Кольцевая линия': '#FFFFAAAA',
                'Люблинско-Дмитровская линия': '#FFCCCCCC',
                'Московская монорельсовая транспортная система': '#FFAAAAAA',
                'Серпуховско-Тимирязевская линия': '#FFAAAAAA',
                'Сокольническая линия': '#FFFF0000',
                'Таганско-Краснопресненская линия': '#FFFF00FF',
                'Филёвская линия': '#FF3333FF'
            }

        };
    </script>
</body>
</html>
