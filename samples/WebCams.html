<!DOCTYPE html>
<html>
    <head>
        <title>sGis Framework - Map Tip with Web Cameras Sample</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width">
        <style>
            body, html {margin: 0px; overflow: hidden; height: 100%;}
            div#map {width: 100%; height: 100%;}
        </style>

        <script src="../Source/sGis/sGis.js"></script>
        <script src="../Source/sGis/Geotools.js"></script>
        <script src="../Source/sGis/RBush.js"></script>
        <script src="../Source/sGis/Event.js"></script>
        <script src="../Source/sGis/utils.js"></script>
        <script src="../Source/sGis/utils/utils.js"></script>
        <script src="../Source/sGis/utils/proto.js"></script>
        <script src="../Source/sGis/utils/svg.js"></script>
        <script src="../Source/sGis/Crs.js"></script>
        <script src="../Source/sGis/IEventHandler.js"></script>
        <script src="../Source/sGis/geom.js"></script>
        <script src="../Source/sGis/Painter.js"></script>
        <script src="../Source/sGis/Layer.js"></script>
        <script src="../Source/sGis/LayerGroup.js"></script>
        <script src="../Source/sGis/Map.js"></script>
        <script src="../Source/sGis/TileLayer.js"></script>
        <script src="../Source/sGis/DynamicLayer.js"></script>
        <script src="../Source/sGis/FeatureLayer.js"></script>
        <script src="../Source/sGis/ESRIDynamicLayer.js"></script>
        <script src="../Source/sGis/Decorations.js"></script>
        <script src="../Source/sGis/geom/Arc.js"></script>
        <script src="../Source/sGis/geom/Point.js"></script>
        <script src="../Source/sGis/geom/Polyline.js"></script>
        <script src="../Source/sGis/geom/Polygon.js"></script>
        <script src="../Source/sGis/symbols/Symbol.js"></script>
        <script src="../Source/sGis/symbols/Maptip.js"></script>
        <script src="../Source/sGis/symbols/Point.js"></script>
        <script src="../Source/sGis/symbols/Polyline.js"></script>
        <script src="../Source/sGis/symbols/Polygon.js"></script>
        <script src="../Source/sGis/features/Feature.js"></script>
        <script src="../Source/sGis/features/Image.js"></script>
        <script src="../Source/sGis/features/FeatureGroup.js"></script>
        <script src="../Source/sGis/features/Point.js"></script>
        <script src="../Source/sGis/features/Polyline.js"></script>
        <script src="../Source/sGis/features/Polygon.js"></script>
        <script src="../Source/sGis/features/Label.js"></script>
        <script src="../Source/sGis/features/Maptip.js"></script>
        <script src="../Source/sGis/features/PointGroup.js"></script>
        <script src="../Source/sGis/controls/Control.js"></script>
        <script src="../Source/sGis/controls/Point.js"></script>
        <script src="../Source/sGis/controls/Polyline.js"></script>
        <script src="../Source/sGis/controls/Polygon.js"></script>
        <script src="../Source/sGis/controls/Editor.js"></script>
        <script src="../Source/sGis/controls/Distance.js"></script>
        <script src="../Source/sGis/controls/Area.js"></script>
        <script src="../Source/sGis/controls/Rectangle.js"></script>
        <script src="../Source/sGis/controls/BaseLayerSwitch.js"></script>

        <script src="../Source/spatialProcessor/Connector.js"></script>
        <script src="../Source/spatialProcessor/utils.js"></script>
        <script src="../Source/spatialProcessor/MapServer.js"></script>
        <script src="../Source/spatialProcessor/DataTree.js"></script>
        <script src="../Source/spatialProcessor/xmlSerializer.js"></script>
        <script src="../Source/spatialProcessor/Sfs.js"></script>
        <script src="../Source/spatialProcessor/Template.js"></script>
        <script src="../Source/spatialProcessor/Printer.js"></script>
        <script src="../Source/spatialProcessor/controller/Controller.js"></script>
        <script src="../Source/spatialProcessor/controller/Identify.js"></script>
        <script src="../Source/spatialProcessor/controller/SuperSearch.js"></script>
        <script src="../Source/spatialProcessor/controller/DitIntegration.js"></script>
        <script src="../Source/spatialProcessor/controller/ClientLayer.js"></script>
        <script src="../Source/spatialProcessor/controller/DefinitionQuery.js"></script>
        <script src="../Source/spatialProcessor/controller/TableView.js"></script>
        <script src="../Source/spatialProcessor/DataAccessService.js"></script>

        <script src="../Source/spatialProcessor/mapItem/MapItem.js"></script>
        <script src="../Source/spatialProcessor/mapItem/Folder.js"></script>
        <script src="../Source/spatialProcessor/mapItem/MapServer.js"></script>
        <script src="../Source/spatialProcessor/mapItem/ClientLayer.js"></script>
        <script src="../Source/spatialProcessor/mapItem/DynamicServiceLayer.js"></script>

        <script src="../Source/spatialProcessor/SpatialProcessor.js"></script>

        <script src="../Source/spatialProcessor/Application.js"></script>

    </head>
    <body>
        <!--
            Пример отображения видео-контента в баллуне
        -->
        <div id="map"></div>
        <script>
            window.onload = function() {
            
            var sp = new sGis.SpatialProcessor({
                    url: 'http://dev2.everpoint.ru/EverGIS/SpatialProcessor/IIS/', login: 'z', password: 'x',
                    mapWrapper: 'map',
                    services: ['Basemaps/osm', 'DIT/dit_cams'],
                    controllers: ['identify']
                }),
                featureLayer = new sGis.FeatureLayer(),
                player;
        
            sp.map.addLayer(featureLayer);
            sp.controller.identify.hide();
        
            sp.map.addListener('click', function(sGisEvent) {
                var buffer = sp.map.resolution * 5,
                    point = sGisEvent.point,
                    identifyPolygon = new sGis.feature.Polygon([[point.x - buffer, point.y - buffer], [point.x - buffer, point.y + buffer], [point.x + buffer, point.y + buffer], [point.x + buffer, point.y - buffer]]);
                    
                sp.controller.identify.identify({
                    geometry: identifyPolygon,
                    success: function() {
                        var rows = sp.controller.identify.tree.rows;

                        for (var i in rows) {
                            if (rows[i].dataType === 'LeafNode') {
                                query(rows[i].data.StorageId);
                                return;
                            }
                        }
                    }
                });
                
                function query(storageId) {
                    sp.controller.identify.query({
                            storageId: storageId, 
                            success: function(objects) {
                                closeMaptip();
                                
                                player = document.createElement('iframe');
                                player.src = objects[0].attributes.url.value;
                                player.width = 500;
                                player.height = 400;
                                player.style.position = 'absolute';
                                player.style.transformOrigin = 'left top';
                                player.style.backgroundColor = 'white';     
                                
                                var button = document.createElement('input');
                                button.type = 'button';
                                button.value = 'X';
                                button.onclick = closeMaptip;

                                var position = objects[0].coordinates,
                                    maptip = new sGis.feature.Maptip(position, {crs: sp.map.crs, content: button, style: {width: 505, height: 430, offset: {x: -255, y: -440}}});
                                featureLayer.add(maptip);
                                sp.map.redrawLayer(featureLayer);

                                updatePlayerPosition();

                                sp.map.innerWrapper.appendChild(player);

                                function closeMaptip() {
                                    sp.map.removeListener('.player');
                                    featureLayer.features = [];
                                    if (player) {
                                        sp.map.innerWrapper.removeChild(player);
                                        player = null;
                                    }
                                    sp.map.redrawLayer(featureLayer);
                                }

                                sp.map.addListener('bboxChange.player', updatePlayerPosition);

                                function updatePlayerPosition() {
                                    var offset = sp.map.getPxPosition(position);

                                    player.style.top = offset.y + maptip.style.offset.y + 25 + 'px';
                                    player.style.left = offset.x + maptip.style.offset.x + 'px';
                                }

                                var startResolution, startBbox;

                                sp.map.addListener('animationStart.player', function() {
                                    startResolution = sp.map.resolution;
                                    startBbox = sp.map.bbox;
                                });

                                sp.map.addListener('animationFrame.player', function() {
                                    var scale = startResolution / sp.map.resolution,
                                        offset = sp.map.getPxPosition(position);


                                    player.style.top = offset.y + maptip.style.offset.y * scale + 25 + 'px';
                                    player.style.left = offset.x + maptip.style.offset.x * scale + 'px';                            
                                    player.style.transform = 'scale(' + scale + ')';
                                });

                                sp.map.addListener('animationEnd.player', function() {
                                    updatePlayerPosition();
                                    player.style.transform = 'scale(1)';
                                });
                            }
                        });
                };   
                
            });
            }
        </script>
    </body>
</html>
