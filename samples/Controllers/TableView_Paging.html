<!DOCTYPE html>
<html>
<head>
    <title>sGis Framework - Identification Sample</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width">
    <style>
        body, html {margin: 0px; overflow: hidden; height: 100%;}
        div#map {width: 100%; height: 100%;}
        div#output {width: 330px; position: absolute; right: 15px; top: 45px; background-color: rgba(255, 255, 255, 0.8); max-height: calc(100% - 50px); overflow-y: auto; }
        button#findMore { position: absolute; right: 15px; width: 330px; top: 10px; height: 25px; }
    </style>

    <script src="http://dev2.everpoint.ru/EverGIS/HTML5/006/evergis.js"></script>

</head>
<body>
    <div id="map"></div>
    <div id="output"></div>
    <button id="findMore">Искать ещё</button>

    <script>
        window.onload = function() {

            var sp = new sGis.SpatialProcessor({
                url: 'http://dev2.everpoint.ru/evergis/SpatialProcessor/IIS/', login: 'jspublic', password: 'jspublic',
                mapWrapper: 'map',
                services: ['osm', 'evergisjs_mrc_test']
            });

            var tableView = sp.addController('tableView');

            function requestObjects(pageIndex) {
                if (!sp.service.evergisjs_mrc_test.initialized) return;

                var storageId = sp.service.evergisjs_mrc_test.mapItem.children[1].storageId;
                tableView.runQuery({
                    storageId: storageId,
                    pageIndex: pageIndex,
                    success: function (data) {
                        var totalObjects = data.pagingInfo.ItemCount;
                        var receivedObjects = data.orderedIds.length;

                        var output = 'Найденные объекты (' + receivedObjects + ' из ' + totalObjects + ', стр. ' + (pageIndex+1) + '):<ul>';

                        data.orderedIds.forEach(function (id) {
                            output += '<li>' + data.objects[id].attributes['TEXT_'].value + '</li>';
                        });

                        output += '</ul>';

                        document.getElementById('output').innerHTML = output;

                        if (currentPage >= data.pagingInfo.PagesCount) currentPage = -1;
                    },
                    error: function (error) {
                        console.error('Ошибка при получении данных.');
                    }
                });
            }

            var currentPage = 0;
            sp.service.evergisjs_mrc_test.on('initialize', function () {
                requestObjects(currentPage);
            });

            document.getElementById('findMore').onclick = function() {
                requestObjects(++currentPage);
            }
        }
    </script>
</body>
</html>
